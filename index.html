<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wap Batata Recheada</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:Arial;} 
        body{height:100vh;overflow:hidden;background:#fff8e1} 
        
        /* LOGIN */
        #login{
            height:100vh;
            display:flex;
            justify-content:center;
            align-items:center;
            background:linear-gradient(45deg,#ffcc00,#ff0000);
            background-image: url('https://images.unsplash.com/photo-1617196031636-c5d45b4a1f47?fit=crop&w=1400&q=80');
            background-size: cover;
            background-position: center;
        }

        .loginBox{
            background:white;
            padding:40px;
            border-radius:15px;
            width:90%;
            max-width:350px;
            text-align:center;
            box-shadow:0 0 20px rgba(0,0,0,0.3);
        }

        .loginBox h2{ color:#d32f2f; margin-bottom:15px; }
        .loginBox input{ width:100%; padding:12px; margin:10px 0; border:2px solid #ffcc00; border-radius:8px; }
        .loginBox button{ width:100%; padding:12px; background:#d32f2f; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold; }

        /* SISTEMA */
        #sistema{ display:none; height:100vh; display:flex; }

        .sidebar{ width:220px; background:#d32f2f; color:white; padding:20px; display:flex; flex-direction:column; }
        .sidebar h3{ margin-bottom:20px; }
        .sidebar button{ background:#ffcc00; border:none; color:#b71c1c; padding:10px; margin-bottom:10px; cursor:pointer; font-weight:bold; border-radius:6px; }
        .sidebar button:hover{ background:white; }

        .content{ flex:1; padding:20px; overflow:auto; background:#fffde7; }
        .pagina{display:none;}
        .card{ background:white; padding:20px; border-radius:12px; margin-bottom:20px; box-shadow:0 3px 10px rgba(0,0,0,0.1); border-left:8px solid #d32f2f; }
        
        table{ width:100%; border-collapse:collapse; margin-top:10px; color: black; }
        th{ background:#d32f2f; color:white; }
        th,td{ border:1px solid #ccc; padding:8px; }

        button.action{ background:#d32f2f; color:white; border:none; padding:8px 12px; cursor:pointer; margin-top:10px; border-radius:6px; font-weight: bold; }
        input.trocoInput, input.chatInput, .formInput{ width:100%; padding:8px; margin-top:10px; border:1px solid #ccc; border-radius:6px; }

        /* CHAT MODAL */
        #chatModal{ position:fixed; right:20px; bottom:20px; width:300px; background:white; border-radius:12px; box-shadow:0 0 15px rgba(0,0,0,0.3); display:none; flex-direction:column; max-height:400px; z-index: 1000; }
        #chatHeader{ background:#d32f2f; color:white; padding:10px; border-radius:12px 12px 0 0; font-weight:bold; display:flex; justify-content:space-between; align-items:center; }
        #chatBox{ flex:1; padding:10px; overflow-y:auto; background:#fff9c4; color: black; }
        #chatInputContainer{ display:flex; padding:10px; border-top:1px solid #ccc; }
        
        /* CÓDIGO DE BARRAS */
        #barcodeScanner{ width:100%; min-height:250px; margin-top:10px; border-radius:8px; background: #000; }
    </style>
</head>
<body>

<div id="login">
    <div class="loginBox">
        <h2> Wap Batata Recheada</h2>
        <input type="text" id="user" placeholder="Usuário">
        <input type="password" id="pass" placeholder="Senha">
        <button onclick="login()">Entrar</button>
    </div>
</div>

<div id="sistema">
    <div class="sidebar">
        <h3> Wap Batata</h3>
        <button onclick="mostrar('cardapio')">Cardápio</button>
        <button onclick="mostrar('pedidos')">Pedidos</button>
        <button onclick="mostrar('vendas')">Vendas</button>
        <button onclick="mostrar('cozinha')">Cozinha</button>
        <button onclick="mostrar('codigoBarras')">Código de Barras</button>
        <button onclick="abrirChat()">Chat Cozinha</button>
        <button onclick="logout()" style="margin-top:auto; background: white; color: #d32f2f;">Sair</button>
    </div>

    <div class="content">
        <div id="cardapio" class="pagina">
            <div class="card">
                <h3>Cadastro de Batatas</h3>
                <input type="text" id="barcodeInput" class="formInput" placeholder="Código de Barras (Escaneie primeiro)">
                <input type="text" id="nomeProd" class="formInput" placeholder="Nome da Batata">
                <input type="number" id="precoProd" class="formInput" placeholder="Preço">
                <button class="action" onclick="addProduto()">Adicionar Batata</button>
            </div>
            <div class="card">
                <table id="tabelaProd">
                    <thead><tr><th>Produto</th><th>Preço</th><th>Editar Preço</th><th>Deletar</th></tr></thead>
                    <tbody id="corpoTabela"></tbody>
                </table>
            </div>
        </div>

        <div id="pedidos" class="pagina">
            <div class="card">
                <h3>Novo Pedido</h3>
                <button class="action" style="background: #27ae60; width: 100%; margin-bottom: 10px;" onclick="mostrar('codigoBarras')"> ESCANEAR PRODUTO</button>
                <select id="listaProdutos" class="formInput"></select>
                <input type="number" id="quantidade" value="1" min="1" class="formInput">
                <button class="action" onclick="addPedido()">Adicionar ao Pedido</button>
                <button class="action" onclick="enviarCozinha()" style="background: #e67e22;">Enviar para Cozinha</button>
            </div>
            <div class="card" style="color: black;">
                <h4>Itens:</h4>
                <ul id="itensPedido"></ul>
                <hr>
                <h4>Total: R$ <span id="totalPedido">0</span></h4>
                <input type="number" id="valorRecebido" class="trocoInput" placeholder="Valor Recebido">
                <button class="action" onclick="calcularTroco()">Calcular Troco</button>
                <p>Troco: R$ <span id="troco">0</span></p>
                <button class="action" onclick="finalizarPedido()" style="background:#27ae60; width:100%;">Finalizar Pedido</button>
            </div>
        </div>

        <div id="vendas" class="pagina">
            <div class="card"><h3>Histórico de Vendas</h3><ul id="listaHistorico" style="color:black"></ul></div>
        </div>

        <div id="cozinha" class="pagina">
            <div class="card"><h3>Pedidos na Cozinha</h3><ul id="listaCozinha" style="color:black"></ul></div>
        </div>

        <div id="codigoBarras" class="pagina">
            <div class="card">
                <h3>Escaneie o Produto</h3>
                <div id="barcodeScanner"></div>
                <button class="action" onclick="stopScanner()" style="width:100%">Parar Scanner</button>
            </div>
        </div>
    </div>
</div>

<div id="chatModal">
    <div id="chatHeader"><span>Chat Cozinha</span><button onclick="fecharChat()" style="background:none; border:none; color:white; font-weight:bold; cursor:pointer;">X</button></div>
    <div id="chatBox"><ul id="chatLista" style="list-style:none"></ul></div>
    <div id="chatInputContainer">
        <input type="text" id="chatInput" placeholder="Mensagem...">
        <button onclick="enviarChat()">Enviar</button>
    </div>
</div>

<script>
let total=0; 
let usuarioAtual=""; 
let cardapio = JSON.parse(localStorage.getItem('wap_cardapio')) || {};
let html5QrCode;

// FUNÇÃO DE LOGIN ATUALIZADA COM NOVOS USUÁRIOS
function login(){
    usuarioAtual = document.getElementById("user").value.trim().toLowerCase();
    let pass = document.getElementById("pass").value.trim();
    
    // Lista de usuários permitidos
    const usuariosPermitidos = ["talyta", "kleyton", "rafael", "kemilly"];
    
    if(usuariosPermitidos.includes(usuarioAtual) && pass === "2312"){
        document.getElementById("login").style.display="none";
        document.getElementById("sistema").style.display="flex";
        atualizarInterface();
    } else { 
        alert("Login ou senha incorretos"); 
    }
}

function mostrar(id){
    document.querySelectorAll(".pagina").forEach(p=>p.style.display="none");
    document.getElementById(id).style.display="block";
    if(id === 'codigoBarras') { startScanner(); } else { stopScanner(); }
}

function logout(){ location.reload(); }

function addProduto(){
    let nome=document.getElementById("nomeProd").value;
    let preco=parseFloat(document.getElementById("precoProd").value);
    let cod=document.getElementById("barcodeInput").value.trim();
    if(!nome || !preco) return;
    let id = cod || nome;
    cardapio[id] = { nome: nome, preco: preco };
    localStorage.setItem('wap_cardapio', JSON.stringify(cardapio));
    document.getElementById("nomeProd").value = "";
    document.getElementById("precoProd").value = "";
    document.getElementById("barcodeInput").value = "";
    atualizarInterface();
}

function atualizarInterface(){
    let corpo = document.getElementById("corpoTabela");
    let select = document.getElementById("listaProdutos");
    corpo.innerHTML = "";
    select.innerHTML = "";
    for(let id in cardapio){
        let p = cardapio[id];
        let row = corpo.insertRow();
        row.insertCell(0).innerText = p.nome;
        row.insertCell(1).innerText = "R$ " + p.preco.toFixed(2);
        let cellEdit = row.insertCell(2);
        let inp = document.createElement("input");
        inp.type="number"; inp.value=p.preco; inp.style.width="70px";
        inp.onchange = function(){ cardapio[id].preco = parseFloat(this.value); localStorage.setItem('wap_cardapio', JSON.stringify(cardapio)); atualizarInterface(); };
        cellEdit.appendChild(inp);
        let cellDel = row.insertCell(3);
        let btn = document.createElement("button"); btn.innerText="Deletar"; btn.className="action";
        btn.onclick = function(){ delete cardapio[id]; localStorage.setItem('wap_cardapio', JSON.stringify(cardapio)); atualizarInterface(); };
        cellDel.appendChild(btn);
        let opt = document.createElement("option");
        opt.value = id;
        opt.text = p.nome + " - R$ " + p.preco.toFixed(2);
        select.appendChild(opt);
    }
}

function addPedido(){
    let id = document.getElementById("listaProdutos").value;
    let qtd = parseInt(document.getElementById("quantidade").value);
    if(!cardapio[id] || qtd < 1) return;
    let p = cardapio[id];
    let li = document.createElement("li");
    li.innerText = p.nome + " x" + qtd + " - R$ " + (p.preco * qtd).toFixed(2);
    document.getElementById("itensPedido").appendChild(li);
    total += (p.preco * qtd);
    document.getElementById("totalPedido").innerText = total.toFixed(2);
}

function calcularTroco(){
    let valor=parseFloat(document.getElementById("valorRecebido").value);
    if(!valor) return;
    document.getElementById("troco").innerText=(valor-total).toFixed(2);
}

function finalizarPedido(){
    if(total===0) return;
    let li=document.createElement("li");
    li.innerText="Venda: R$ "+total.toFixed(2) + " (" + new Date().toLocaleTimeString() + ")";
    document.getElementById("listaHistorico").appendChild(li);
    total=0; document.getElementById("itensPedido").innerHTML=""; document.getElementById("totalPedido").innerText="0"; document.getElementById("troco").innerText="0";
}

function enviarCozinha(){
    let itens = document.getElementById("itensPedido").innerText;
    if(!itens) return;
    let li = document.createElement("li");
    li.innerHTML = itens + " <button class='action' onclick='this.parentElement.remove()'>OK</button>";
    document.getElementById("listaCozinha").appendChild(li);
    alert("Enviado!");
}

function abrirChat(){document.getElementById("chatModal").style.display="flex";}
function fecharChat(){document.getElementById("chatModal").style.display="none";}
function enviarChat(){
    let texto=document.getElementById("chatInput").value; if(!texto) return;
    let li=document.createElement("li"); li.innerText=usuarioAtual+": "+texto;
    document.getElementById("chatLista").appendChild(li); document.getElementById("chatInput").value="";
}

function startScanner(){
    if(html5QrCode) return;
    html5QrCode = new Html5Qrcode("barcodeScanner");
    html5QrCode.start({ facingMode: "environment" }, { fps:10, qrbox:250 },
        codigo => {
            if(cardapio[codigo]){
                document.getElementById("listaProdutos").value = codigo;
                alert("Produto encontrado: " + cardapio[codigo].nome);
                mostrar('pedidos');
            } else {
                document.getElementById("barcodeInput").value = codigo;
                alert("Novo código! Cadastre o nome e preço.");
                mostrar('cardapio');
            }
        },
        err => {}
    ).catch(e => alert("Erro na câmera: Verifique o HTTPS."));
}

function stopScanner(){
    if(html5QrCode){ html5QrCode.stop().then(()=>html5QrCode=null); }
}

window.onload=atualizarInterface;
</script>
</body>
</html>
